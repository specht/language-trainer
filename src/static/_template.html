<!DOCTYPE html>
<html lang="de">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Γνῶθι σεαυτόν</title>
    #{meta_tags || ''}
    <link href="/gen/css/compiled-#{compiled_css_sha1}.css" rel="stylesheet" />

    <style>
        body {
            /* background: linear-gradient(rgb(8, 66, 100), rgb(8, 66, 100)), url(images/stock.jpg); */
            /* background-blend-mode: multiply; */
            background-color: rgb(10, 45, 73);
        }

        .navbar {
            background-color: #e8e8e8;
        }

        .container {
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
            padding-top: 30px;
            background-color: rgba(255, 255, 255, 0.75);
            padding-bottom: 30px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            /*         overflow-x: scroll; */
        }

        .container-fluid {
            padding-top: 30px;
            padding-bottom: 30px;
        }

        .container-fluid.solid {
            background-color: rgba(255, 255, 255, 0.75);
        }

        .form-control:disabled {
            opacity: 0.7;
        }

        .form-control[readonly] {
            background-color: rgba(255, 255, 255, 0.5);
        }

        hr {
            border-top: 1px solid rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 575px) {
            .container {
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }
        }
    </style>
    <script defer src="/gen/js/compiled-#{compiled_js_sha1}.js"></script>

    #{PAGE_CSS_HERE}
</head>

<body>

    <script>
        var poll_run_data = null;
        var force_close_poll_response = false;
        var CAN_HANDLE_EXTERNAL_USERS = false;

        function collect_poll_run_data() {
            // returns whether we have pending changes
            poll_run_data.response = {};
            let answered_item_count = 0;
            let total_item_count = 0;
            for (let item_index in poll_run_data.poll_run.items) {
                let item = poll_run_data.poll_run.items[item_index];
                if (item.type === 'radio') {
                    total_item_count += 1;
                    poll_run_data.response[item_index] = null;
                    if (poll_run_data.widgets[item_index].find('.selected').length > 0)
                        poll_run_data.response[item_index] = parseInt($(poll_run_data.widgets[item_index].find('.selected').eq(0)).data('answer-index'));
                    if (poll_run_data.response[item_index] !== null)
                        answered_item_count += 1;
                } else if (item.type === 'checkbox') {
                    total_item_count += 1;
                    poll_run_data.response[item_index] = [];
                    jQuery.each(poll_run_data.widgets[item_index].find('.selected'), function (_, p) {
                        let answer_index = parseInt($(p).data('answer-index'));
                        poll_run_data.response[item_index].push(answer_index);
                    });
                    if (poll_run_data.response[item_index].length > 0)
                        answered_item_count += 1;
                } else if (item.type === 'textarea') {
                    let s = poll_run_data.widgets[item_index].val().trim();
                    if (s.length > 0)
                        poll_run_data.response[item_index] = s;
                }
            }
            $('.poll-run-progress').css('width', `${answered_item_count * 100 / total_item_count}%`);
            $('.poll-run-progress-label').text(`${answered_item_count} von ${total_item_count} Frage${total_item_count === 1 ? '' : 'n'} beantwortet`);
            for (let k in poll_run_data.response) {
                if (poll_run_data.response[k] === null || (typeof (poll_run_data.response[k]) === 'object' && poll_run_data.response[k].length === 0))
                    delete poll_run_data.response[k];
            }
            let current_response_json = JSON.stringify(poll_run_data.response);
            let stored_response_json = JSON.stringify(poll_run_data.stored_response);
            if (current_response_json !== stored_response_json) {
                $('#bu_hide_poll_run').prop('disabled', true);
                $('#bu_discard_poll_results').prop('disabled', false).removeClass('btn-outline-secondary').addClass('btn-secondary');
                $('#bu_submit_poll_results').prop('disabled', false).removeClass('btn-outline-success').addClass('btn-success');
                $('#bu_close_poll_response_modal').prop('disabled', true).removeClass('btn-secondary').addClass('btn-outline-secondary');
                return true;
            } else {
                $('#bu_hide_poll_run').prop('disabled', false);
                $('#bu_discard_poll_results').prop('disabled', true).removeClass('btn-secondary').addClass('btn-outline-secondary');
                $('#bu_submit_poll_results').prop('disabled', true).removeClass('btn-success').addClass('btn-outline-success');
                $('#bu_close_poll_response_modal').prop('disabled', false).removeClass('btn-outline-secondary').addClass('btn-secondary');
                return false;
            }
        }

        function launch_poll(prid, external_code) {
            if (typeof (external_code) === 'undefined')
                external_code = null;
            force_close_poll_response = false;
            poll_run_data = {};
            poll_run_data.widgets = {};
            (function (external_code) {
                api_call('/api/get_poll_run', { prid: prid, external_code: external_code }, function (data) {
                    if (data.success) {
                        poll_run_data.prid = data.poll_run.id;
                        poll_run_data.external_code = external_code;
                        poll_run_data.poll = data.poll;
                        poll_run_data.poll_run = data.poll_run;
                        poll_run_data.organizer = data.organizer;
                        poll_run_data.total_participants = data.total_participants;
                        poll_run_data.stored_response = data.stored_response;
                        if (poll_run_data.poll_run.anonymous) {
                            $('.poll-run-anonymous').show();
                            $('.poll-run-non-anonymous').hide();
                        } else {
                            $('.poll-run-anonymous').hide();
                            $('.poll-run-non-anonymous').show();
                        }
                        $('#pollResponseModal .poll-run-organizer').text(data.organizer);
                        $('#pollResponseModal .poll-run-total-participants').text(`${data.total_participants}`);
                        $('#pollResponseModal .poll-title').text(data.poll.title);
                        $('#pollResponseModal .poll_submit_success').hide();
                        if (JSON.stringify(poll_run_data.stored_response) === '{}')
                            $('#pollResponseModal .poll_submit_update_message').hide();
                        else
                            $('#pollResponseModal .poll_submit_update_message').show();
                        $('#pollResponseModal .poll_submit_error').hide();
                        let div = $('#pollResponseModal .poll-items');
                        div.empty();
                        for (let item_index in data.poll_run.items) {
                            let item = data.poll_run.items[item_index];
                            let item_title = $('<p>').append($('<strong>').text(item.title));
                            if (item.type === 'checkbox') {
                                if ((item.max_checks || null) !== null) {
                                    item_title.append(' ').append($('<em>').html(`(Mehrfachnennungen möglich, aber <strong>höchstens ${item.max_checks} Antworten</strong>.)`));
                                } else {
                                    item_title.append(' ').append($('<em>').text('(Mehrfachnennungen möglich)'));
                                }
                            }
                            div.append(item_title);
                            if (item.type === 'radio' || item.type === 'checkbox') {
                                let bc = $('<div>').addClass('poll_radio_buttons').data('item-index', item_index);
                                poll_run_data.widgets[item_index] = bc;
                                bc.data('poll_item_type', item.type);
                                for (let answer_index in item.answers) {
                                    let answer = item.answers[answer_index];
                                    let p = $('<p>').text(answer).data('answer-index', answer_index);
                                    if (item.type === 'radio')
                                        p.prepend($("<i class='icon icon-selected fa fa-dot-circle-o'></i>"));
                                    else
                                        p.prepend($("<i class='icon icon-selected fa fa-check-circle-o'></i>"));
                                    p.prepend($("<i class='icon icon-unselected fa fa-circle-thin'></i>"));
                                    if (item.type === 'radio') {
                                        if ((poll_run_data.stored_response || {})[item_index] == answer_index)
                                            p.addClass('selected');
                                    } else if (item.type === 'checkbox') {
                                        if ((((poll_run_data.stored_response || {})[item_index]) || []).indexOf(parseInt(answer_index)) >= 0)
                                            p.addClass('selected');
                                    }
                                    p.click(function (e) {
                                        let p = $(e.target);
                                        let parent = $(e.target.closest('.poll_radio_buttons'));
                                        let item_index = parent.data('item-index');
                                        let item = poll_run_data.poll_run.items[item_index];
                                        let answer_index = p.data('answer-index');
                                        let type = parent.data('poll_item_type');
                                        let p_was_selected = p.hasClass('selected');
                                        if (type === 'radio') {
                                            parent.find('p').removeClass('selected');
                                        }
                                        if (p_was_selected) {
                                            p.removeClass('selected');
                                        } else {
                                            // check if max_checks is set
                                            if ((item.type === 'checkbox') && (item.max_checks || null)) {
                                                let count = 0;
                                                jQuery.each(poll_run_data.widgets[item_index].find('.selected'), function (_, p) {
                                                    count += 1;
                                                });
                                                if (count < item.max_checks)
                                                    p.addClass('selected');
                                            }
                                            else
                                                p.addClass('selected');
                                        }
                                        collect_poll_run_data();
                                    });
                                    bc.append(p);
                                }
                                div.append(bc);
                            } else if (item.type === 'textarea') {
                                let textarea = $('<textarea>').addClass('form-control').data('item-index', item_index).css('margin-bottom', '15px');
                                textarea.val((poll_run_data.stored_response || {})[item_index] || '');
                                poll_run_data.widgets[item_index] = textarea;
                                textarea.change(function (e) { collect_poll_run_data(); });
                                div.append(textarea);
                            } else if (item.type === 'paragraph') {
                                let p = $('<p>').css('white-space', 'pre-line').text(item.text);
                                div.append(p);
                            }
                        }
                        collect_poll_run_data();
                        if (external_code !== null && external_code.length > 0)
                            $('#bu_hide_poll_run').hide();
                        else
                            $('#bu_hide_poll_run').show();
                        $('#pollResponseModal').modal('show');
                    }
                });
            })(external_code);
        }

        function show_poll_run_results(prid) {
            api_call('/api/get_poll_run_results', { prid: prid }, function (data) {
                if (data.success) {
                    $('#bu_poll_run_results_download_pdf').attr('href', `/api/poll_run_results_pdf/${data.prid}`);
                    $('#bu_poll_run_results_download_zip').attr('href', `/api/poll_run_results_zip/${data.prid}`);
                    $('#bu_poll_run_results_download_xlsx').attr('href', `/api/poll_run_results_xlsx/${data.prid}`);
                    if (data.anonymous) {
                        $('#bu_poll_run_results_download_zip').hide();
                        $('#bu_poll_run_results_download_xlsx').hide();
                    }
                    else {
                        $('#bu_poll_run_results_download_zip').show();
                        $('#bu_poll_run_results_download_xlsx').show();
                    }
                    $('#pollRunResultsModal .poll-title').html(data.title);
                    $('#pollRunResultsModal .poll-run-results-here').html(data.html);
                    $('#pollRunResultsModal').modal('show');
                }
            });
        }

    </script>

    <div class="modal" id="__template_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true" style='z-index: 200000;'>
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                    </h5>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-expand-md navbar-light fixed-top justify-content-end">
        <a class="navbar-brand" href="/">
            <img src='/images/icon.png'
                style='border-radius: 100%; width: 48px; height: 48px; position: absolute; top: 5px;' /><span
                class='brand-brand agr' style='margin-left: 60px;'>Γνῶθι σεαυτόν</span>
        </a>
        <div class='ml-auto'></div>
        #{nav_items()}
    </nav>
    <div>
        #{CONTENT}
    </div>
    <!-- <div class='snowman'></div> -->
    <div class='foot text-muted'>
        <span class='float-left'>&copy; 2022 <a href='https://gymnasiumsteglitz.de' target='_blank'>Gymnasium
                Steglitz</a></span>
    </div>
    <div class='info' style='display: none;'></div>

</body>

</html>